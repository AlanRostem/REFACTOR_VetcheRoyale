<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: client/js/Game/Scene.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: client/js/Game/Scene.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// All game rendering and UI elements
// should loop here.

import R from "../Graphics/Renderer.js"
import AssetManager from "../AssetManager/AssetManager.js"
import CEventManager from "../CEventManager.js"
import UI from "../UI/JSONToHTML.js";
import MiniMap from "../UI/MiniMap.js";
import KelvinBar from "../UI/KelvinBar.js";
import CrossHair from "../UI/Crosshair.js";
import HPBar from "../UI/HPBar.js";
import GunBox from "../UI/GunBox.js";
import ModBox from "../UI/ModBox.js";
import Stats from "../UI/Stats.js";


import TileMapManager from "./TileBased/TileMapManager.js"
import Announcement from "../UI/Announcement.js";
import EnemyDetector from "../UI/EnemyDetector.js";

/**
 * The main object on the client that renders the game world and UI.
 * @namespace Scene
 * @memberOf ClientSide
 */
const Scene = {
    deltaTime: 0,
    lastTime: 0,
    currentMap: "MegaMap",
    entityManager: null,
    eventManager: null,
    clientRef: null,


    /**
     * Get the current tile map name that is displayed
     * @memberOf Scene
     * @returns {string}
     */
    get currentMapName() {
        return Scene.currentMap;
    },

    set currentMapName(val) {
        Scene.currentMap = val;
    },

    get entities() {
        return Scene.entityManager;
    },

    /**
     * Initialization entry point for setting up certain things such as UI and game world variables on the client
     * @memberOf Scene
     */
    setup() {
        Scene.tileMaps = new TileMapManager();
        Scene.tileMaps.createMap("MegaMap", "tilemaps/MegaMap.json");
        Scene.tileMaps.createMap("lobby", "tilemaps/lobby.json");
        Scene.tileMaps.createMap("hub", "tilemaps/hub.json");
        AssetManager.addDownloadCallback(() => {
            UI.setup(() => {
                UI.append(new MiniMap());
                UI.append(new Announcement());
                UI.append(new KelvinBar());
                UI.append(new HPBar());
                UI.append(new GunBox());
                UI.append(new ModBox());
                UI.append(new Stats());
                UI.append(new EnemyDetector());
                UI.append(new CrossHair()); // Remember to keep this at the bottom
            });
            UI.init();
        });

    },

    /**
     * Retrieves the current displayed tile map
     * @memberOf Scene
     * @returns {CTileMap}
     */
    getCurrentTileMap() {
        return Scene.tileMaps.getMap(Scene.currentMapName);
    },

    /**
     * Start the client side application
     * @memberOf Scene
     * @param entityManager {CEntityManager} - Main client entity manager
     * @param client {CClient} - Reference to the end user object
     */
    run(entityManager, client) {
        Scene.clientRef = client;
        Scene.entityManager = entityManager;
        Scene.eventManager = new CEventManager(); // TODO::Kor ska denne?

        Scene.setup();
        Scene.tick();
    },

    /**
     * Game loop that runs after the asset manager successfully loads all assets
     * @memberOf Scene
     */
    update() {
        if (AssetManager.done()) {
            Scene.clientRef.update(Scene.entityManager, Scene.deltaTime);
            Scene.eventManager.update(Scene.clientRef, Scene.deltaTime);
            UI.update(Scene.deltaTime, Scene.clientRef, Scene.entityManager);
            Scene.entityManager.updateEntities(Scene.deltaTime, Scene.clientRef, Scene.tileMaps.getMap(Scene.currentMap));
            R.camera.update()
        }
    },

    /**
     * Draw loop that runs after the asset manager successfully loads all assets
     * @memberOf Scene
     */
    draw() {
        R.clear();
        if (Scene.clientRef.disconnected) {
            R.drawText("YOU HAVE BEEN DISCONNECTED", (R.screenSize.x / 2 | 0) - "YOU HAVE BEEN DISCONNECTED".length * 4 / 2,
                R.screenSize.y / 2 | 0, "Red");
            R.drawText(Scene.clientRef.discReasonMsg, (R.screenSize.x / 2 | 0) -
                4 * Scene.clientRef.discReasonMsg.length / 2,
                (R.screenSize.y / 2 | 0) + 8, "Red");
            R.drawText(Scene.clientRef.discActionMsg, (R.screenSize.x / 2 | 0) -
                4 * Scene.clientRef.discActionMsg.length / 2,
                (R.screenSize.y / 2 | 0) + 16, "Red");
            return;
        }

        if (AssetManager.done()) {
            Scene.tileMaps.getMap(Scene.currentMapName).draw();
            Scene.entityManager.drawEntities();
            UI.draw();
            R.drawText(Scene.clientRef.latency + "ms", 4, 4, "White");
            document.body.style.cursor = "none";
        } else {
            document.body.style.cursor = "default";
            var str = "Loading " +
                (((AssetManager.successCount + AssetManager.errorCount) / AssetManager.downloadQueue.length) * 100 | 0)
                + "%";
            R.drawText(str,
                (R.screenSize.x / 2 | 0) - R.context.measureText(str).width / 2,
                R.screenSize.y / 2 | 0,
                "Green");

            R.drawText("Sphinx of black quartz, judge my vow...",
                (R.screenSize.x / 3 | 0) - R.context.measureText(str).width / 2,
                R.screenSize.y / 1.5 | 0,
                "Green");

        }
    },

    tick(time) {
        if (time > 0)
            Scene.deltaTime = (time - Scene.lastTime) / 1000;

        Scene.update();
        Scene.draw();

        if (time > 0)
            Scene.lastTime = time;

        requestAnimationFrame(Scene.tick);
    }
};

export default Scene;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="ClientSide.html">ClientSide</a></li><li><a href="ClientSide.EntityTypeSpawner.html">EntityTypeSpawner</a></li><li><a href="ClientSide.R.html">R</a></li><li><a href="ClientSide.Scene.html">Scene</a></li></ul><h3>Classes</h3><ul><li><a href="Announcement.html">Announcement</a></li><li><a href="Camera.html">Camera</a></li><li><a href="CClient.html">CClient</a></li><li><a href="ClientSide.AnimationManager.html">AnimationManager</a></li><li><a href="ClientSide.AssetManager.html">AssetManager</a></li><li><a href="ClientSide.CEntity.html">CEntity</a></li><li><a href="ClientSide.JSONFile.html">JSONFile</a></li><li><a href="ClientSide.RemotePlayer.html">OtherPlayer</a></li><li><a href="ClientSide.SpriteSheet.html">SpriteSheet</a></li><li><a href="ClientSide.SpriteSheet.Animation.html">Animation</a></li><li><a href="ClientSide.TileSheet.html">TileSheet</a></li><li><a href="ClientSide.UserPlayer.html">UserPlayer</a></li><li><a href="CTileMap.html">CTileMap</a></li><li><a href="EntityManager.html">EntityManager</a></li><li><a href="MiniMap.html">MiniMap</a></li><li><a href="TileMapManager.html">TileMapManager</a></li><li><a href="UIElement.html">UIElement</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sun Sep 29 2019 20:47:49 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
